<div class="dashboard-container">
  <!-- Sidebar -->
  <app-sidebar></app-sidebar>

  <!-- Loading Overlay -->
  <app-loading-spinner *ngIf="isLoading" [overlay]="true" message="Carregando dados..."></app-loading-spinner>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header -->
    <header class="dashboard-header">
      <div class="header-title">
        <i class="fa-solid fa-chart-line header-icon"></i>
        <h1>Visão Geral</h1>
      </div>
    </header>

    <!-- Development Message Alert -->
    <div class="development-alert" *ngIf="developmentMessage">
      <div class="alert-icon">
        <i class="fa-solid fa-code"></i>
      </div>
      <div class="alert-content">
        <strong>Funcionalidade em Desenvolvimento</strong>
        <p>{{ developmentMessage }}</p>
      </div>
      <button class="alert-close" (click)="developmentMessage = ''">
        <i class="fa-solid fa-times"></i>
      </button>
    </div>

    <!-- Error State -->
    <app-error-message 
      *ngIf="hasError && !isLoading"
      [title]="'Erro ao carregar dashboard'"
      [message]="errorMessage || 'Não foi possível carregar os dados do dashboard. Tente novamente.'"
      (retry)="retryLoad()">
    </app-error-message>

    <!-- Content -->
    <ng-container *ngIf="!isLoading && !hasError">
      <!-- Cards de Resumo -->
    <section class="summary-cards">
      <div class="card card-primary">
        <div class="card-icon">
          <i class="fa-solid fa-wallet"></i>
        </div>
        <div class="card-content">
          <h3>Saldo Atual</h3>
          <p class="card-value" [class.negative]="balance < 0">{{ formatCurrency(balance) }}</p>
        </div>
      </div>

      <div class="card card-income">
        <div class="card-icon">
          <i class="fa-solid fa-arrow-trend-up"></i>
        </div>
        <div class="card-content">
          <h3>Recebido</h3>
          <p class="card-value">{{ formatCurrency(received) }}</p>
        </div>
      </div>

      <div class="card card-expense">
        <div class="card-icon">
          <i class="fa-solid fa-arrow-trend-down"></i>
        </div>
        <div class="card-content">
          <h3>Gasto</h3>
          <p class="card-value">{{ formatCurrency(spent) }}</p>
        </div>
      </div>

      <div class="card card-investment">
        <div class="card-icon">
          <i class="fa-solid fa-chart-pie"></i>
        </div>
        <div class="card-content">
          <h3>Investido</h3>
          <p class="card-value">{{ formatCurrency(invested) }}</p>
        </div>
      </div>
    </section>

    <!-- Gráficos -->
    <section class="charts-section">
      <div class="chart-card chart-line">
        <div class="chart-header">
          <h3>Evolução Financeira (Semana)</h3>
        </div>
        <div class="chart-header">
          <div class="chart-legend">
            <span class="legend-item">
              <span class="legend-dot" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);"></span>
              Despesas
            </span>
            <span class="legend-item">
              <span class="legend-dot" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);"></span>
              Receitas
            </span>
          </div>
        </div>
        <div class="chart-content">
          <svg viewBox="0 0 160 90" class="bar-chart" preserveAspectRatio="xMidYMid meet">
            <!-- Grid lines -->
            <line x1="12" y1="15" x2="155" y2="15" stroke="#e2e8f0" stroke-width="0.3" stroke-dasharray="1"/>
            <line x1="12" y1="35" x2="155" y2="35" stroke="#e2e8f0" stroke-width="0.3" stroke-dasharray="1"/>
            <line x1="12" y1="55" x2="155" y2="55" stroke="#e2e8f0" stroke-width="0.3" stroke-dasharray="1"/>
            <line x1="12" y1="75" x2="155" y2="75" stroke="#e2e8f0" stroke-width="0.3" stroke-dasharray="1"/>
            
            <!-- Barras do gráfico -->
            <g *ngFor="let point of chartData; let i = index">
              <!-- Barra de Despesas (vermelha) -->
              <rect
                [attr.x]="getBarX(i, 0)"
                [attr.y]="getBarY(point.expenses, getMaxValue())"
                [attr.width]="getBarWidth()"
                [attr.height]="getBarHeight(point.expenses, getMaxValue())"
                fill="#ef4444"
                class="chart-bar"
                rx="0.5"
                (mouseenter)="showTooltip($event, point.label + ' - Despesas: ' + formatCurrency(point.expenses))"
                (mouseleave)="hideTooltip()"
              />
              <!-- Barra de Receitas (verde) -->
              <rect
                [attr.x]="getBarX(i, 1)"
                [attr.y]="getBarY(point.revenues, getMaxValue())"
                [attr.width]="getBarWidth()"
                [attr.height]="getBarHeight(point.revenues, getMaxValue())"
                fill="#10b981"
                class="chart-bar"
                rx="0.5"
                (mouseenter)="showTooltip($event, point.label + ' - Receitas: ' + formatCurrency(point.revenues))"
                (mouseleave)="hideTooltip()"
              />
            </g>
            
            <!-- Eixos -->
            <line x1="12" y1="10" x2="12" y2="80" stroke="#94a3b8" stroke-width="0.4" opacity="0.5"/>
            <line x1="12" y1="80" x2="155" y2="80" stroke="#94a3b8" stroke-width="0.4" opacity="0.5"/>
            
            <!-- Labels do eixo X -->
            <text 
              *ngFor="let point of chartData; let i = index"
              [attr.x]="getBarGroupCenter(i)"
              y="88"
              text-anchor="middle"
              font-size="3"
              fill="#64748b"
              font-weight="500">
              {{ point.label }}
            </text>
          </svg>
        </div>
      </div>

      <!-- Card de Top Categorias -->
      <div class="chart-card categories-card">
        <div class="categories-content">
          <!-- Receitas -->
          <div class="category-section">
            <div class="category-header">
              <i class="fa-solid fa-arrow-trend-up" style="color: #10b981;"></i>
              <h4>Maiores Receitas</h4>
            </div>
            <div class="category-list">
              <div class="category-item" *ngFor="let item of topRevenueCategories">
                <div class="category-info">
                  <div class="category-dot" style="background: #10b981;"></div>
                  <span class="category-name">{{ item.category }}</span>
                </div>
                <span class="category-amount positive">{{ formatCurrency(item.amount) }}</span>
              </div>
              <div class="empty-category" *ngIf="topRevenueCategories.length === 0">
                <i class="fa-solid fa-inbox"></i>
                <p>Nenhuma receita</p>
              </div>
            </div>
          </div>

          <div class="category-divider"></div>

          <!-- Despesas -->
          <div class="category-section">
            <div class="category-header">
              <i class="fa-solid fa-arrow-trend-down" style="color: #ef4444;"></i>
              <h4>Maiores Despesas</h4>
            </div>
            <div class="category-list">
              <div class="category-item" *ngFor="let item of topExpenseCategories">
                <div class="category-info">
                  <div class="category-dot" style="background: #ef4444;"></div>
                  <span class="category-name">{{ item.category }}</span>
                </div>
                <span class="category-amount negative">{{ formatCurrency(item.amount) }}</span>
              </div>
              <div class="empty-category" *ngIf="topExpenseCategories.length === 0">
                <i class="fa-solid fa-inbox"></i>
                <p>Nenhuma despesa</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

      <!-- Movimentações Financeiras -->
      <section class="transactions-section">
        <div class="section-header">
          <h2>Movimentações Recentes</h2>
          <button class="btn-add" (click)="addTransaction()"><i class="fa-solid fa-plus"></i> Nova Transação</button>
        </div>

        <!-- Empty State -->
        <app-empty-state 
          *ngIf="transactions.length === 0"
          [icon]="'fa-solid fa-money-bill-transfer'"
          [title]="'Nenhuma movimentação'"
          [message]="'Você ainda não possui movimentações financeiras. Comece adicionando sua primeira transação.'"
          [actionLabel]="'Adicionar Movimentação'">
        </app-empty-state>

        <!-- Transactions Table -->
        <div class="transactions-table" *ngIf="transactions.length > 0">
          <table>
            <thead>
              <tr>
                <th>Descrição</th>
                <th>Categoria</th>
                <th>Data</th>
                <th>Valor</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let transaction of transactions">
                <td class="transaction-desc">{{ transaction.description || 'Sem descrição' }}</td>
                <td><span class="transaction-category">{{ getCategoryName(transaction.category_uuid, transaction.type) }}</span></td>
                <td class="transaction-date">{{ transaction.date || (transaction.transaction_date | date: 'dd/MM/yyyy') }}</td>
                <td class="transaction-amount" [class.income]="transaction.type === 'income'" [class.expense]="transaction.type === 'expense'">
                  {{ transaction.type === 'income' ? '+' : '-' }} {{ formatCurrency(transaction.amount) }}
                </td>
                <td class="transaction-actions">
                  <button class="action-icon" [class.income]="transaction.type === 'income'" [class.expense]="transaction.type === 'expense'">
                    <i class="fa-solid" [class.fa-arrow-up]="transaction.type === 'income'" [class.fa-arrow-down]="transaction.type === 'expense'"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </ng-container>
  </main>

  <!-- Transaction Modal -->
  <app-transaction-modal 
    (onSuccess)="onTransactionSuccess()">
  </app-transaction-modal>
  
  <!-- Tooltip -->
  <div class="chart-tooltip" *ngIf="tooltipVisible" [style.left.px]="tooltipX" [style.top.px]="tooltipY">
    {{ tooltipContent }}
  </div>
</div>
